<div class="shell">
  <aside class="sidebar">
    <div class="sidebar__brand">
      <div class="sidebar__logo" aria-hidden="true">
        <img src="/bjorn-logo.svg" alt="Bjorn AI" />
      </div>
      <div class="sidebar__text">
        <p class="eyebrow">Bjorn AI</p>
        <h1>Seu copiloto</h1>
        <p class="subtitle">Organize documentos e converse em um s√≥ lugar.</p>
      </div>
    </div>

    <nav class="sidebar__nav" aria-label="Navega√ß√£o principal">
      <button type="button" (click)="setActiveSection('intro')" [class.active]="activeSection() === 'intro'">
        <span class="sidebar__icon">‚ú®</span>
        Apresenta√ß√£o
      </button>
      <button type="button" (click)="setActiveSection('chat')" [class.active]="activeSection() === 'chat'">
        <span class="sidebar__icon">üí¨</span>
        Chat
      </button>
      <button type="button" (click)="setActiveSection('docs')" [class.active]="activeSection() === 'docs'">
        <span class="sidebar__icon">üìé</span>
        Anexar documentos
      </button>
    </nav>

    <div class="sidebar__footer"></div>
  </aside>

  <main class="workspace">
    <header class="workspace__header">
      <div>
        <p class="eyebrow">Bjorn AI</p>
        <h2>
          {{
            activeSection() === 'intro'
              ? 'Bem-vindo ao Bjorn'
              : activeSection() === 'chat'
                ? 'Converse com o agente'
                : 'Organize sua base de PDFs'
          }}
        </h2>
        <p class="subtitle">
          {{
            activeSection() === 'intro'
              ? 'Saiba como o Bjorn acelera seus estudos e entregas em engenharia el√©trica.'
              : activeSection() === 'chat'
                ? 'Envie mensagens, acompanhe o hist√≥rico e recupere conversas anteriores com um s√≥ clique.'
                : 'Fa√ßa upload dos materiais em PDF e acompanhe o progresso de indexa√ß√£o.'
          }}
        </p>
      </div>
    </header>

    <section *ngIf="activeSection() === 'intro'" class="panel hero">
      <div class="hero__copy">
        <p class="eyebrow">Apresenta√ß√£o</p>
        <h3>Seu copiloto em engenharia el√©trica</h3>
        <p class="subtitle">
          O Bjorn interpreta especifica√ß√µes, esquemas e cadernos de exerc√≠cios para explicar conceitos,
          preparar relat√≥rios e destrinchar c√°lculos com foco em aprendizado r√°pido.
        </p>
        <div class="hero__highlights">
          <div class="pill">Documenta√ß√£o t√©cnica guiada</div>
          <div class="pill">An√°lise de PDFs volumosos</div>
          <div class="pill">Contexto persistente entre conversas</div>
        </div>
        <div class="hero__cta">
          <button type="button" (click)="setActiveSection('chat')">Abrir chat</button>
          <button type="button" class="ghost" (click)="setActiveSection('docs')">Anexar documentos</button>
        </div>
      </div>
      <div class="hero__visual" aria-hidden="true">
        <img src="/bjorn-logo.svg" alt="Ilustra√ß√£o do Bjorn com barba como agente el√©trico" />
        <div class="hero__badge">
          <span>Especialista</span>
          <strong>Engenharia El√©trica</strong>
        </div>
      </div>
    </section>

    <section *ngIf="activeSection() === 'docs'" class="panel uploads">
      <div class="uploads__header">
        <div>
          <p class="eyebrow">Base de conhecimento</p>
          <h3>Enviar documentos em PDF</h3>
          <p class="subtitle">
            Anexe os arquivos da sua disciplina e envie para
            <code>http://localhost:8080/api/knowledge/ELECTRICAL/docs</code>.
            Aceitamos m√∫ltiplos PDFs (at√© ~1GB) e mostraremos o progresso do envio.
          </p>
        </div>
        <div class="uploads__actions">
          <label class="upload-button" for="documentInput">
            <input
              id="documentInput"
              type="file"
              multiple
              accept="application/pdf"
              (change)="onFilesSelected($event)"
            />
            Anexar documentos
          </label>
          <button type="button" (click)="uploadDocuments()" [disabled]="!canUploadDocuments()">
            Enviar para indexa√ß√£o
          </button>
        </div>
      </div>

      <div class="uploads__helper">
        <span>{{ uploadItems().length }} arquivo(s) selecionado(s)</span>
        <span>Total: {{ formatBytes(totalUploadSize()) }}</span>
        <span *ngIf="isUploadingDocuments()">Progresso: {{ uploadProgress() }}%</span>
      </div>

      <div class="feedback" *ngIf="uploadError() as uploadErrorMessage">
        <p>‚ö†Ô∏è {{ uploadErrorMessage }}</p>
      </div>

      <div class="success" *ngIf="uploadSuccess()">
        ‚úÖ Documentos enviados para indexa√ß√£o com sucesso.
      </div>

      <div class="uploads__grid" *ngIf="uploadItems().length; else emptyUploads">
        <div class="upload-card" *ngFor="let item of uploadItems(); let i = index">
          <div class="upload-card__info">
            <span class="upload-card__title" [title]="item.file.name">{{ item.file.name }}</span>
            <span class="upload-card__meta">{{ formatBytes(item.file.size) }}</span>
          </div>
          <div class="upload-card__progress" *ngIf="isUploadingDocuments()">
            <div
              class="upload-card__bar"
              role="progressbar"
              aria-valuemin="0"
              aria-valuemax="100"
              [attr.aria-valuenow]="uploadProgress()"
              [style.width.%]="uploadProgress()"
            ></div>
            <span class="upload-card__progress-value">{{ uploadProgress() }}%</span>
          </div>
          <button type="button" class="ghost" (click)="removeUploadItem(i)" [disabled]="isUploadingDocuments()">
            Remover
          </button>
        </div>
      </div>
      <ng-template #emptyUploads>
        <div class="empty">
          <p>Nenhum PDF selecionado. Clique em ‚ÄúAnexar documentos‚Äù para come√ßar.</p>
        </div>
      </ng-template>
    </section>

    <section *ngIf="activeSection() === 'chat'" class="chat-layout">
      <div class="panel chat-panel">
        <div class="conversation" *ngIf="conversationId(); else loadingConversation">
          <div class="conversation__badge">
            <span class="label">Conversa ativa</span>
            <span class="value">#{{ conversationId() }}</span>
          </div>
          <button type="button" (click)="startNewConversation()" [disabled]="isInitializing() || isSending()">
            Nova conversa
          </button>
        </div>
        <ng-template #loadingConversation>
          <div class="conversation conversation--loading">
            <span class="label">Iniciando conversa com o backend...</span>
          </div>
        </ng-template>

        <form class="form" (submit)="onSubmit($event)" novalidate>
          <label for="message">Mensagem</label>
          <textarea
            id="message"
            name="message"
            [formControl]="messageControl"
            placeholder="Ex.: Ol√° Bjorn, quais s√£o minhas tarefas de hoje?"
            rows="4"
            [attr.aria-invalid]="messageControl.invalid"
          ></textarea>

          <div class="helper">
            <span *ngIf="messageControl.invalid && (messageControl.touched || messageControl.dirty)">
              A mensagem √© obrigat√≥ria e deve ter no m√°ximo 500 caracteres.
            </span>
            <span class="status" [class.loading]="isSending()">
              <ng-container *ngIf="isInitializing(); else sendingState">
                {{ 'Conectando ao backend...' }}
              </ng-container>
              <ng-template #sendingState>
                {{ isSending() ? 'Enviando...' : 'Pronto para enviar' }}
              </ng-template>
            </span>
          </div>

          <button type="submit" [disabled]="!canSubmit">Enviar mensagem</button>
        </form>

        <div class="feedback" *ngIf="error() as errorMessage">
          <p>‚ö†Ô∏è {{ errorMessage }}</p>
        </div>

        <div class="chat chat--main" *ngIf="history().length; else emptyState">
          <div class="entry" *ngFor="let item of displayHistory()" [class.user]="item.role === 'user'">
            <div class="entry__header">
              <span class="role">{{ item.role === 'user' ? 'Voc√™' : 'Bjorn' }}</span>
              <span class="meta" *ngIf="item.createdAt">{{ item.createdAt | date: 'short' }}</span>
            </div>
            <p>{{ item.text }}</p>
          </div>
        </div>
        <ng-template #emptyState>
          <div class="empty">
            <p>Envie sua primeira mensagem para iniciar a conversa.</p>
          </div>
        </ng-template>
      </div>

      <div class="panel previous-panel" [class.previous--open]="showPreviousConversations()">
        <div class="previous__header">
          <div>
            <p class="eyebrow eyebrow--ghost">Hist√≥rico</p>
            <h3>Conferir conversas anteriores</h3>
            <p class="subtitle" *ngIf="hasPreviousConversations(); else noHistoryCopy">
              Revise rapidamente o que j√° foi discutido sem sair da conversa atual.
            </p>
            <ng-template #noHistoryCopy>
              <p class="subtitle">
                As conversas anteriores aparecem aqui quando voc√™ inicia uma nova sess√£o. Clique para abrir o
                painel e voltar para elas sempre que precisar.
              </p>
            </ng-template>
          </div>
          <button type="button" class="ghost" (click)="togglePreviousConversations()">
            {{ showPreviousConversations() ? 'Ocultar hist√≥rico' : 'Mostrar hist√≥rico' }}
            <span *ngIf="hasPreviousConversations()">({{ previousConversations().length }})</span>
          </button>
        </div>

        <div class="previous__content" *ngIf="showPreviousConversations()">
          <div class="previous__list" role="list" *ngIf="hasPreviousConversations(); else emptyPrevious">
            <button
              type="button"
              role="listitem"
              *ngFor="let id of previousConversations()"
              (click)="loadPreviousConversation(id)"
              [class.active]="id === selectedPreviousConversationId()"
              [disabled]="previousConversationLoading()"
            >
              #{{ id }}
            </button>
          </div>

          <ng-template #emptyPrevious>
            <div class="empty inline">
              <p>Nenhuma conversa anterior encontrada. Inicie uma nova conversa para salv√°-la aqui.</p>
            </div>
          </ng-template>

          <div class="previous__details" *ngIf="selectedPreviousConversationId(); else previousHint">
            <div class="helper">
              <span class="status" [class.loading]="previousConversationLoading()">
                {{ previousConversationLoading() ? 'Carregando mensagens...' : '√öltimas mensagens' }}
              </span>
              <span class="meta">Conversa #{{ selectedPreviousConversationId() }}</span>
            </div>

            <div class="feedback" *ngIf="previousConversationError() as previousError">
              <p>‚ö†Ô∏è {{ previousError }}</p>
            </div>

            <div class="chat compact" *ngIf="previousConversationHistory().length; else noPreviousMessages">
              <div
                class="entry"
                *ngFor="let item of previousDisplayHistory()"
                [class.user]="item.role === 'user'"
              >
                <div class="entry__header">
                  <span class="role">{{ item.role === 'user' ? 'Voc√™' : 'Bjorn' }}</span>
                  <span class="meta" *ngIf="item.createdAt">{{ item.createdAt | date: 'short' }}</span>
                </div>
                <p>{{ item.text }}</p>
              </div>
            </div>
            <ng-template #noPreviousMessages>
              <div class="empty">
                <p>Sem mensagens armazenadas para esta conversa.</p>
              </div>
            </ng-template>
          </div>

          <ng-template #previousHint>
            <div class="empty">
              <p>Selecione uma conversa anterior para revisar as mensagens.</p>
            </div>
          </ng-template>
        </div>
      </div>
    </section>
  </main>
</div>
