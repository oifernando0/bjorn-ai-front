<main class="page">
  <section class="hero">
    <div class="hero__copy">
      <p class="eyebrow">Bjorn AI</p>
      <h1>Seu agente para engenharia elétrica</h1>
      <p class="subtitle">
        Converse com o Bjorn, um especialista em engenharia elétrica que documenta, analisa e detalha
        projetos técnicos para acelerar seu trabalho diário.
      </p>
    </div>
    <div class="hero__visual" aria-hidden="true">
      <img src="/bjorn-logo.svg" alt="Ilustração do Bjorn com barba como agente elétrico" />
    </div>
  </section>

  <section class="card uploads">
    <div class="uploads__header">
      <div>
        <p class="eyebrow">Base de conhecimento</p>
        <h2>Enviar documentos em PDF</h2>
        <p class="subtitle">
          Anexe os arquivos da sua disciplina e envie para <code>http://localhost:8080/api/knowledge/ELECTRICAL/docs</code>.
          Aceitamos múltiplos PDFs (até ~1GB) e mostraremos o progresso do envio.
        </p>
      </div>
      <div class="uploads__actions">
        <label class="upload-button" for="documentInput">
          <input
            id="documentInput"
            type="file"
            multiple
            accept="application/pdf"
            (change)="onFilesSelected($event)"
          />
          Anexar documentos
        </label>
        <button type="button" (click)="uploadDocuments()" [disabled]="!canUploadDocuments()">
          Enviar para indexação
        </button>
      </div>
    </div>

    <div class="uploads__helper">
      <span>{{ uploadItems().length }} arquivo(s) selecionado(s)</span>
      <span>Total: {{ formatBytes(totalUploadSize()) }}</span>
      <span *ngIf="isUploadingDocuments()">Progresso: {{ uploadProgress() }}%</span>
    </div>

    <div class="feedback" *ngIf="uploadError() as uploadErrorMessage">
      <p>⚠️ {{ uploadErrorMessage }}</p>
    </div>

    <div class="success" *ngIf="uploadSuccess()">
      ✅ Documentos enviados para indexação com sucesso.
    </div>

    <div class="uploads__grid" *ngIf="uploadItems().length; else emptyUploads">
      <div class="upload-card" *ngFor="let item of uploadItems(); let i = index">
        <div class="upload-card__info">
          <span class="upload-card__title" [title]="item.file.name">{{ item.file.name }}</span>
          <span class="upload-card__meta">{{ formatBytes(item.file.size) }}</span>
        </div>
        <div class="upload-card__progress" *ngIf="isUploadingDocuments()">
          <div
            class="upload-card__bar"
            role="progressbar"
            aria-valuemin="0"
            aria-valuemax="100"
            [attr.aria-valuenow]="uploadProgress()"
            [style.width.%]="uploadProgress()"
          ></div>
          <span class="upload-card__progress-value">{{ uploadProgress() }}%</span>
        </div>
        <button type="button" class="ghost" (click)="removeUploadItem(i)" [disabled]="isUploadingDocuments()">
          Remover
        </button>
      </div>
    </div>
    <ng-template #emptyUploads>
      <div class="empty">
        <p>Nenhum PDF selecionado. Clique em “Anexar documentos” para começar.</p>
      </div>
    </ng-template>
  </section>

  <section class="card">
    <div class="conversation" *ngIf="conversationId(); else loadingConversation">
      <span class="label">Conversa ativa</span>
      <span class="value">#{{ conversationId() }}</span>
      <button type="button" (click)="startNewConversation()" [disabled]="isInitializing() || isSending()">
        Nova conversa
      </button>
    </div>
    <ng-template #loadingConversation>
      <div class="conversation conversation--loading">
        <span class="label">Iniciando conversa com o backend...</span>
      </div>
    </ng-template>

    <form class="form" (submit)="onSubmit($event)" novalidate>
      <label for="message">Mensagem</label>
      <textarea
        id="message"
        name="message"
        [formControl]="messageControl"
        placeholder="Ex.: Olá Bjorn, quais são minhas tarefas de hoje?"
        rows="4"
        [attr.aria-invalid]="messageControl.invalid"
      ></textarea>

      <div class="helper">
        <span *ngIf="messageControl.invalid && (messageControl.touched || messageControl.dirty)">
          A mensagem é obrigatória e deve ter no máximo 500 caracteres.
        </span>
        <span class="status" [class.loading]="isSending()">
          <ng-container *ngIf="isInitializing(); else sendingState">
            {{ 'Conectando ao backend...' }}
          </ng-container>
          <ng-template #sendingState>
            {{ isSending() ? 'Enviando...' : 'Pronto para enviar' }}
          </ng-template>
        </span>
      </div>

      <button type="submit" [disabled]="!canSubmit">Enviar mensagem</button>
    </form>

    <div class="feedback" *ngIf="error() as errorMessage">
      <p>⚠️ {{ errorMessage }}</p>
    </div>

    <div class="chat chat--main" *ngIf="history().length; else emptyState">
      <div class="entry" *ngFor="let item of displayHistory()" [class.user]="item.role === 'user'">
        <div class="entry__header">
          <span class="role">{{ item.role === 'user' ? 'Você' : 'Bjorn' }}</span>
          <span class="meta" *ngIf="item.createdAt">{{ item.createdAt | date: 'short' }}</span>
        </div>
        <p>{{ item.text }}</p>
      </div>
    </div>
    <ng-template #emptyState>
      <div class="empty">
        <p>Envie sua primeira mensagem para iniciar a conversa.</p>
      </div>
    </ng-template>
  </section>

  <section class="previous" [class.previous--open]="showPreviousConversations()">
    <div class="previous__header">
      <div>
        <p class="eyebrow eyebrow--ghost">Histórico</p>
        <h2>Conferir conversas anteriores</h2>
        <p class="subtitle" *ngIf="hasPreviousConversations(); else noHistoryCopy">
          Revise rapidamente o que já foi discutido em conversas anteriores (#1, #2, #3...) sem sair da
          conversa atual.
        </p>
        <ng-template #noHistoryCopy>
          <p class="subtitle">
            As conversas anteriores aparecem aqui quando você inicia uma nova sessão. Clique para abrir o
            painel e voltar para elas sempre que precisar.
          </p>
        </ng-template>
      </div>
      <button type="button" class="ghost" (click)="togglePreviousConversations()">
        {{ showPreviousConversations() ? 'Ocultar histórico' : 'Mostrar histórico' }}
        <span *ngIf="hasPreviousConversations()">({{ previousConversations().length }})</span>
      </button>
    </div>

    <div class="previous__content" *ngIf="showPreviousConversations()">
      <div class="previous__list" role="list" *ngIf="hasPreviousConversations(); else emptyPrevious">
        <button
          type="button"
          role="listitem"
          *ngFor="let id of previousConversations()"
          (click)="loadPreviousConversation(id)"
          [class.active]="id === selectedPreviousConversationId()"
          [disabled]="previousConversationLoading()"
        >
          #{{ id }}
        </button>
      </div>

      <ng-template #emptyPrevious>
        <div class="empty inline">
          <p>Nenhuma conversa anterior encontrada. Inicie uma nova conversa para salvá-la aqui.</p>
        </div>
      </ng-template>

      <div class="previous__details" *ngIf="selectedPreviousConversationId(); else previousHint">
        <div class="helper">
          <span class="status" [class.loading]="previousConversationLoading()">
            {{ previousConversationLoading() ? 'Carregando mensagens...' : 'Últimas mensagens' }}
          </span>
          <span class="meta">Conversa #{{ selectedPreviousConversationId() }}</span>
        </div>

        <div class="feedback" *ngIf="previousConversationError() as previousError">
          <p>⚠️ {{ previousError }}</p>
        </div>

        <div class="chat compact" *ngIf="previousConversationHistory().length; else noPreviousMessages">
          <div
            class="entry"
            *ngFor="let item of previousDisplayHistory()"
            [class.user]="item.role === 'user'"
          >
            <div class="entry__header">
              <span class="role">{{ item.role === 'user' ? 'Você' : 'Bjorn' }}</span>
              <span class="meta" *ngIf="item.createdAt">{{ item.createdAt | date: 'short' }}</span>
            </div>
            <p>{{ item.text }}</p>
          </div>
        </div>
        <ng-template #noPreviousMessages>
          <div class="empty">
            <p>Sem mensagens armazenadas para esta conversa.</p>
          </div>
        </ng-template>
      </div>

      <ng-template #previousHint>
        <div class="empty">
          <p>Selecione uma conversa anterior para revisar as mensagens.</p>
        </div>
      </ng-template>
    </div>
  </section>
</main>
