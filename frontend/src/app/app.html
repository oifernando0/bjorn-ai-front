<main class="page">
  <section class="hero">
    <div class="hero__copy">
      <p class="eyebrow">Bjorn AI</p>
      <h1>Converse com o seu assistente</h1>
      <p class="subtitle">
        Envie mensagens para o backend do Bjorn AI e visualize respostas usando os endpoints de conversa
        REST.
      </p>
      <div class="pill">
        Backend configurável em <code>src/environments/environment.ts</code> (padrão: http://localhost:8080)
      </div>
    </div>
    <div class="hero__visual" aria-hidden="true">
      <img src="/bjorn-ai-hero.svg" alt="Ilustração de um agente elétrico Bjorn AI" />
      <div class="hero__badge">Pronto para falar com o backend</div>
    </div>
  </section>

  <section class="card">
    <div class="conversation" *ngIf="conversationId(); else loadingConversation">
      <span class="label">Conversa ativa</span>
      <span class="value">#{{ conversationId() }}</span>
      <button type="button" (click)="startNewConversation()" [disabled]="isInitializing() || isSending()">
        Nova conversa
      </button>
    </div>
    <ng-template #loadingConversation>
      <div class="conversation conversation--loading">
        <span class="label">Iniciando conversa com o backend...</span>
      </div>
    </ng-template>

    <form class="form" (submit)="onSubmit($event)" novalidate>
      <label for="message">Mensagem</label>
      <textarea
        id="message"
        name="message"
        [formControl]="messageControl"
        placeholder="Ex.: Olá Bjorn, quais são minhas tarefas de hoje?"
        rows="4"
        [attr.aria-invalid]="messageControl.invalid"
      ></textarea>

      <div class="helper">
        <span *ngIf="messageControl.invalid && (messageControl.touched || messageControl.dirty)">
          A mensagem é obrigatória e deve ter no máximo 500 caracteres.
        </span>
        <span class="status" [class.loading]="isSending()">
          <ng-container *ngIf="isInitializing(); else sendingState">
            {{ 'Conectando ao backend...' }}
          </ng-container>
          <ng-template #sendingState>
            {{ isSending() ? 'Enviando...' : 'Pronto para enviar' }}
          </ng-template>
        </span>
      </div>

      <button type="submit" [disabled]="!canSubmit">Enviar mensagem</button>
    </form>

    <div class="feedback" *ngIf="error() as errorMessage">
      <p>⚠️ {{ errorMessage }}</p>
    </div>

    <div class="chat" *ngIf="history().length; else emptyState">
      <div class="entry" *ngFor="let item of history()" [class.user]="item.role === 'user'">
        <div class="entry__header">
          <span class="role">{{ item.role === 'user' ? 'Você' : 'Bjorn' }}</span>
          <span class="meta" *ngIf="item.createdAt">{{ item.createdAt | date: 'short' }}</span>
        </div>
        <p>{{ item.text }}</p>
      </div>
    </div>
    <ng-template #emptyState>
      <div class="empty">
        <p>Envie sua primeira mensagem para iniciar a conversa.</p>
      </div>
    </ng-template>
  </section>
</main>
